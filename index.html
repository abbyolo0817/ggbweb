<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGB互動教學 | 翰林國小數學</title>
    
    <!-- 1. 引入 Tailwind CSS (樣式庫) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 Google Fonts (Zen Maru Gothic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- 3. 引入 Lucide Icons (圖示庫) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 設定全域樣式 -->
    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            font-weight: 700; /* 粗體 */
        }
        
        /* 隱藏捲軸但保留功能 */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 動畫效果 */
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fade-in 0.2s ease-out forwards;
        }

        @keyframes scale-in {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .animate-scale-in {
            animation: scale-in 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* 讀取中旋轉動畫 */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-white text-gray-900 flex flex-col min-h-screen">

    <!-- ================= HEADER 區塊 ================= -->
    <!-- 移除 overflow-hidden，讓底部的尖角可以突出來 -->
    <header class="bg-yellow-400 border-b-4 border-black relative z-30">
        
        <!-- 背景裝飾容器 (加上 overflow-hidden，確保漂浮符號不會跑出去) -->
        <div class="absolute inset-0 pointer-events-none overflow-hidden">
            <!-- 方格紙背景 -->
            <div class="absolute inset-0 opacity-20" 
                 style="background-image: linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px); background-size: 40px 40px;">
            </div>

            <!-- 漂浮的數學符號 -->
            <div class="absolute top-10 left-[5%] text-5xl font-black opacity-20 rotate-12 text-black select-none">+</div>
            <div class="absolute bottom-12 left-[12%] text-6xl font-black opacity-20 -rotate-12 text-black select-none">8</div>
            <div class="absolute top-20 right-[8%] text-5xl font-black opacity-20 rotate-12 text-black select-none">÷</div>
            <div class="absolute bottom-20 right-[15%] text-4xl font-black opacity-20 text-black select-none">3</div>
            <div class="absolute top-8 left-[35%] text-4xl font-black opacity-10 -rotate-6 text-black select-none">×</div>
            <div class="absolute top-12 right-[35%] text-5xl font-black opacity-10 rotate-6 text-black select-none">-</div>
            <div class="absolute top-40 left-[25%] text-3xl font-black opacity-15 rotate-45 text-black select-none">√2</div>
            <div class="absolute bottom-32 left-[40%] text-4xl font-black opacity-15 -rotate-12 text-black select-none">π</div>
            <div class="absolute top-24 right-[28%] text-3xl font-black opacity-15 rotate-90 text-black select-none">∞</div>
            <div class="absolute bottom-10 right-[40%] text-4xl font-black opacity-15 text-black select-none">%</div>
            <div class="absolute top-5 left-[50%] text-3xl font-black opacity-10 rotate-12 text-black select-none">1/2</div>
            <div class="absolute bottom-40 left-[5%] text-5xl font-black opacity-10 -rotate-45 text-black select-none">=</div>
            <div class="absolute top-32 right-[2%] text-4xl font-black opacity-10 rotate-12 text-black select-none">9</div>
            <div class="absolute bottom-5 left-[60%] text-3xl font-black opacity-10 text-black select-none">∠A</div>

            <!-- 兩側裝飾方塊 (SVG) -->
            <div class="hidden lg:block absolute left-4 bottom-12 w-48 h-48 opacity-100 transform -translate-x-4 z-0">
                <svg viewBox="0 0 200 200" fill="none" stroke="black" stroke-width="4" stroke-linejoin="round" stroke-linecap="round">
                    <path d="M50 125 L100 150 L150 125 L100 100 Z" fill="#93C5FD"></path>
                    <path d="M50 125 L100 150 L100 190 L50 165 Z" fill="#3B82F6"></path>
                    <path d="M100 150 L150 125 L150 165 L100 190 Z" fill="#1D4ED8"></path>
                    <path d="M25 85 L75 110 L125 85 L75 60 Z" fill="white"></path>
                    <path d="M25 85 L75 110 L75 150 L25 125 Z" fill="#E5E7EB"></path>
                    <path d="M75 110 L125 85 L125 125 L75 150 Z" fill="#9CA3AF"></path>
                    <path d="M100 75 L150 100 L200 75 L150 50 Z" fill="#BFDBFE"></path>
                    <path d="M100 75 L150 100 L150 140 L100 115 Z" fill="#60A5FA"></path>
                    <path d="M150 100 L200 75 L200 115 L150 140 Z" fill="#2563EB"></path>
                    <path d="M75 35 L125 60 L175 35 L125 10 Z" fill="white"></path>
                    <path d="M75 35 L125 60 L125 100 L75 75 Z" fill="#E5E7EB"></path>
                    <path d="M125 60 L175 35 L175 75 L125 100 Z" fill="#9CA3AF"></path>
                </svg>
            </div>
            <div class="hidden lg:block absolute right-10 top-4 w-48 h-48 opacity-100 transform translate-x-10 -translate-y-4 scale-x-[-1] z-0">
                <svg viewBox="0 0 200 200" fill="none" stroke="black" stroke-width="4" stroke-linejoin="round" stroke-linecap="round">
                    <path d="M50 125 L100 150 L150 125 L100 100 Z" fill="#93C5FD"></path>
                    <path d="M50 125 L100 150 L100 190 L50 165 Z" fill="#3B82F6"></path>
                    <path d="M100 150 L150 125 L150 165 L100 190 Z" fill="#1D4ED8"></path>
                    <path d="M25 85 L75 110 L125 85 L75 60 Z" fill="white"></path>
                    <path d="M25 85 L75 110 L75 150 L25 125 Z" fill="#E5E7EB"></path>
                    <path d="M75 110 L125 85 L125 125 L75 150 Z" fill="#9CA3AF"></path>
                    <path d="M100 75 L150 100 L200 75 L150 50 Z" fill="#BFDBFE"></path>
                    <path d="M100 75 L150 100 L150 140 L100 115 Z" fill="#60A5FA"></path>
                    <path d="M150 100 L200 75 L200 115 L150 140 Z" fill="#2563EB"></path>
                    <path d="M75 35 L125 60 L175 35 L125 10 Z" fill="white"></path>
                    <path d="M75 35 L125 60 L125 100 L75 75 Z" fill="#E5E7EB"></path>
                    <path d="M125 60 L175 35 L175 75 L125 100 Z" fill="#9CA3AF"></path>
                </svg>
            </div>
        </div>

        <!-- 主標題區塊 -->
        <div class="max-w-4xl mx-auto py-6 px-4 text-center relative z-10">
            <div class="inline-block relative px-10 py-6">
                <!-- 手繪風框框背景 (SVG) -->
                <svg viewBox="0 0 400 120" preserveAspectRatio="none" class="absolute inset-0 w-full h-full text-white drop-shadow-[4px_4px_0_rgba(0,0,0,1)]" style="overflow: visible;">
                    <path d="M5,10 Q200,2 395,10 Q398,60 395,110 Q200,118 5,110 Q2,60 5,10 Z" fill="white" stroke="black" stroke-width="4" stroke-linejoin="round"></path>
                </svg>
                
                <div class="relative flex items-center justify-center gap-4">
                    <!-- 彩色幾何圖示 (SVG) -->
                    <svg viewBox="0 0 100 100" class="w-12 h-12 md:w-16 md:h-16 flex-shrink-0" fill="none" stroke="black" stroke-width="4" stroke-linejoin="round" stroke-linecap="round">
                        <circle cx="30" cy="30" r="20" fill="#F87171"></circle>
                        <rect x="45" y="45" width="40" height="40" fill="#60A5FA" transform="rotate(10 65 65)"></rect>
                        <path d="M20 90 L50 90 L35 60 Z" fill="#4ADE80"></path>
                    </svg>
                    
                    <h1 class="text-5xl md:text-7xl font-black text-black tracking-tight">
                        GGB互動教學
                    </h1>
                </div>
            </div>

            <div class="mt-4 flex justify-center items-center gap-2">
                <div class="h-[2px] w-12 bg-black"></div>
                <p class="text-black font-black text-xl md:text-2xl tracking-widest bg-yellow-400 px-4">
                    翰林國小數學
                </p>
                <div class="h-[2px] w-12 bg-black"></div>
            </div>
        </div>

        <!-- 底部尖角 (Speech Bubble Tail) -->
        <div class="absolute -bottom-4 left-1/2 transform -translate-x-1/2 w-8 h-8 bg-yellow-400 border-b-4 border-r-4 border-black rotate-45 z-20"></div>
    </header>

    <!-- ================= 導覽與搜尋 ================= -->
    <nav class="py-8 bg-white relative border-b-2 border-gray-100 z-20">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex flex-col lg:flex-row items-center justify-between gap-6">
                
                <!-- 左側：年級選單 -->
                <div class="flex flex-col md:flex-row items-center gap-4 flex-grow justify-center lg:justify-start">
                    <span class="text-gray-400 text-sm font-bold whitespace-nowrap">請選擇年級</span>
                    <div id="grade-buttons" class="flex flex-wrap justify-center gap-2">
                        <!-- 年級按鈕將由 JavaScript 動態生成 -->
                    </div>
                </div>

                <!-- 右側：搜尋框 -->
                <div class="w-full max-w-xs relative group">
                    <div class="absolute inset-0 bg-black rounded-full translate-x-1 translate-y-1 group-focus-within:translate-x-1.5 group-focus-within:translate-y-1.5 transition-transform"></div>
                    <input type="text" id="search-input" placeholder="搜尋..." 
                           class="relative w-full pl-10 pr-4 py-2 bg-white border-2 border-black rounded-full font-bold text-base focus:outline-none transition-all">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-black z-10"></i>
                    <button id="clear-search" class="absolute right-3 top-1/2 transform -translate-y-1/2 p-0.5 hover:bg-gray-100 rounded-full z-10 hidden">
                        <i data-lucide="x" class="w-4 h-4 text-gray-500"></i>
                    </button>
                </div>
            </div>

            <!-- 搜尋結果提示 -->
            <div id="search-result-hint" class="text-center mt-6 hidden animate-fade-in">
                <p class="text-gray-500 font-bold bg-gray-100 inline-block px-4 py-1 rounded-full text-sm">
                    搜尋結果：<span id="search-term-display"></span> <span class="mx-2 text-gray-300">|</span> 點擊年級按鈕可清除
                </p>
            </div>
        </div>
    </nav>

    <!-- ================= 主要內容區 ================= -->
    <main class="flex-grow px-4 max-w-6xl mx-auto pb-24 w-full pt-8 z-10 min-h-[50vh]">
        
        <!-- 載入中動畫 -->
        <div id="loading-spinner" class="flex flex-col items-center justify-center py-20 text-gray-400 hidden">
            <i data-lucide="loader-2" class="w-12 h-12 animate-spin mb-4 text-yellow-400"></i>
            <p class="text-xl">正在讀取資料...</p>
        </div>

        <!-- 資源卡片列表容器 -->
        <div id="resources-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- 卡片將由 JavaScript 動態生成 -->
        </div>

        <!-- 無資料提示 -->
        <div id="no-data-hint" class="text-center py-20 border-2 border-dashed border-black rounded-xl bg-gray-50 hidden">
            <p class="text-xl font-bold text-gray-500" id="no-data-text">目前沒有相關資源</p>
            <p class="text-md text-gray-400 mt-2">請確認 Google Sheet 資料或嘗試其他年級</p>
        </div>
    </main>

    <!-- ================= 頁尾 ================= -->
    <footer class="bg-yellow-400 border-t-2 border-black py-8 text-center relative z-10">
        <p class="text-black font-bold">
            &copy; <span id="current-year"></span> GGB互動教學資源網. All rights reserved.
        </p>
    </footer>

    <!-- ================= 回到頂端按鈕 ================= -->
    <button id="scroll-to-top" 
            class="fixed bottom-8 right-8 bg-yellow-400 border-2 border-black p-3 rounded-full shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[-2px] hover:translate-x-[-2px] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] transition-all z-40 hidden">
        <i data-lucide="arrow-up" class="w-8 h-8 text-black stroke-[3]"></i>
    </button>

    <!-- ================= 彈出視窗 (Modal) ================= -->
    <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm hidden animate-fade-in" onclick="closeModal()">
        <div id="modal-content" class="bg-white w-full max-w-4xl rounded-xl border-4 border-black shadow-[8px_8px_0px_0px_rgba(255,255,255,0.2)] relative overflow-hidden flex flex-col md:flex-row items-stretch animate-scale-in" onclick="event.stopPropagation()">
            
            <!-- 關閉按鈕 -->
            <button onclick="closeModal()" class="absolute top-4 right-4 z-10 p-2 bg-white border-2 border-black hover:bg-red-500 hover:text-white rounded-full transition-colors">
                <i data-lucide="x" class="w-6 h-6 stroke-[3]"></i>
            </button>

            <!-- 左側：資訊與預覽圖 -->
            <div class="w-full md:w-1/2 p-8 flex flex-col justify-between bg-yellow-50 border-b-4 md:border-b-0 md:border-r-4 border-black relative overflow-hidden">
                <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(45deg, #000 1px, transparent 1px); background-size: 20px 20px;"></div>
                
                <div class="flex flex-col items-center justify-center flex-grow z-10">
                    <div class="transform scale-100 mb-8 mt-4 w-full h-48 flex items-center justify-center">
                        <!-- 預覽圖容器 -->
                        <div id="modal-image-container" class="w-full h-full flex items-center justify-center">
                            <!-- 圖片將由 JS 插入 -->
                        </div>
                    </div>
                    <div class="text-center space-y-3 w-full mb-8">
                        <h2 id="modal-title" class="text-3xl font-black text-black"></h2>
                        <div id="modal-subtitle" class="inline-block bg-white border-2 border-black px-4 py-1 rounded-full font-bold"></div>
                    </div>
                </div>

                <a id="modal-link-btn" href="#" target="_blank" rel="noopener noreferrer" 
                   class="mt-auto flex items-center justify-center w-full py-4 bg-yellow-400 hover:bg-yellow-300 text-black font-black text-lg border-2 border-black rounded-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[-2px] hover:translate-y-[-2px] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] transition-all active:translate-x-0 active:translate-y-0 active:shadow-none z-10">
                    <i data-lucide="external-link" class="w-6 h-6 mr-2 stroke-[3]"></i>
                    前往資源網站
                </a>
            </div>

            <!-- 右側：QR Code -->
            <div class="w-full md:w-1/2 p-8 flex flex-col justify-between bg-white gap-6">
                <div class="flex flex-col items-center justify-center flex-grow">
                    <div class="group bg-white p-4 border-4 border-black rounded-xl relative cursor-zoom-in hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] transition-all hover:-translate-y-1 hover:-translate-x-1"
                         onclick="toggleFullQr()">
                        <div class="absolute top-2 left-2 w-1.5 h-1.5 bg-black rounded-full"></div>
                        <div class="absolute top-2 right-2 w-1.5 h-1.5 bg-black rounded-full"></div>
                        <div class="absolute bottom-2 left-2 w-1.5 h-1.5 bg-black rounded-full"></div>
                        <div class="absolute bottom-2 right-2 w-1.5 h-1.5 bg-black rounded-full"></div>
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/5 z-10">
                            <i data-lucide="zoom-in" class="w-12 h-12 text-black drop-shadow-lg"></i>
                        </div>
                        <img id="modal-qr-img" src="" alt="QR Code" class="w-64 h-64 object-contain">
                        <p class="text-center font-bold mt-2 text-gray-500 group-hover:text-black transition-colors">點擊放大</p>
                    </div>
                </div>
                <div class="w-full mt-auto">
                    <div class="flex items-center space-x-2 bg-gray-100 p-2 rounded-lg border-2 border-black h-[60px]">
                        <div id="modal-url-text" class="flex-grow px-2 text-sm text-black truncate font-mono font-bold"></div>
                        <button onclick="copyUrl()" class="p-2 hover:bg-yellow-300 rounded border-2 border-transparent hover:border-black text-black transition-all relative group" title="複製網址">
                            <i data-lucide="copy" class="w-5 h-5"></i>
                            <span id="copy-tooltip" class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-black text-yellow-400 text-xs py-1 px-3 rounded font-bold whitespace-nowrap hidden">COPIED!</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 全螢幕 QR Code 視窗 -->
    <div id="full-qr-overlay" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md hidden animate-fade-in" onclick="toggleFullQr()">
        <div class="relative bg-white p-6 rounded-2xl border-4 border-yellow-400 animate-scale-in max-w-[90vw] max-h-[90vh]" onclick="event.stopPropagation()">
            <button onclick="toggleFullQr()" class="absolute -top-6 -right-6 z-10 p-2 bg-white border-2 border-black hover:bg-red-500 hover:text-white rounded-full transition-colors shadow-lg">
                <i data-lucide="x" class="w-8 h-8 stroke-[3]"></i>
            </button>
            <div class="flex flex-col items-center">
                <h3 id="full-qr-title" class="text-2xl font-black mb-4"></h3>
                <img id="full-qr-img" src="" alt="QR Code Full" class="w-full h-auto max-w-md max-h-[60vh] object-contain border-4 border-black rounded-lg">
                <p class="mt-4 font-bold text-gray-500">掃描 QR Code 進入課程</p>
            </div>
        </div>
    </div>

    <!-- ================= JavaScript 邏輯 ================= -->
    <script>
        // ==========================================
        // ★★★ 請在此填入您的 Apps Script 網址 ★★★
        // ==========================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwdpD61m1E9wGnvowKs-0slpgM0GETLBgsQ3xn_yC3MToGS0ddsNL4Qk4fuxFhVeIzUvg/exec"; 

        // 預設資料 (若沒有填寫 URL 或載入失敗時顯示)
        let resources = [
            { id: 1, grade: "5下", title: "範例資源 1", subTitle: "請填入 Apps Script 網址", url: "https://www.geogebra.org/", image: "img/demo1.png" },
            { id: 2, grade: "5下", title: "範例資源 2", subTitle: "預設顯示資料", url: "https://www.geogebra.org/", image: "img/demo2.png" }
        ];

        const GRADES = ["3上", "3下", "4上", "4下", "5上", "5下", "6上", "6下"];
        let selectedGrade = "3上";
        let searchTerm = "";
        let currentModalResource = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            renderGrades();
            
            if (GOOGLE_SCRIPT_URL) {
                fetchData();
            } else {
                renderResources();
            }

            // 初始化 Lucide Icons
            lucide.createIcons();

            // 綁定搜尋事件
            document.getElementById('search-input').addEventListener('input', (e) => {
                searchTerm = e.target.value;
                handleSearch();
            });

            // 綁定清除搜尋
            document.getElementById('clear-search').addEventListener('click', () => {
                searchTerm = "";
                document.getElementById('search-input').value = "";
                handleSearch();
            });

            // 綁定捲動事件
            window.addEventListener('scroll', handleScroll);
            document.getElementById('scroll-to-top').addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });

        // 抓取資料
        async function fetchData() {
            const spinner = document.getElementById('loading-spinner');
            const grid = document.getElementById('resources-grid');
            
            spinner.classList.remove('hidden');
            grid.innerHTML = ''; // 清空目前顯示

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                // 處理 ID
                resources = data.map((item, index) => ({
                    ...item,
                    id: item.id || `sheet-${index}`
                }));
            } catch (error) {
                console.error("Error fetching data:", error);
                // 失敗時保持使用預設資料或顯示錯誤
            } finally {
                spinner.classList.add('hidden');
                renderResources();
            }
        }

        // 渲染年級按鈕
        function renderGrades() {
            const container = document.getElementById('grade-buttons');
            container.innerHTML = '';

            GRADES.forEach(grade => {
                const btn = document.createElement('button');
                // 樣式邏輯
                const isActive = (selectedGrade === grade && !searchTerm);
                let classes = "px-4 py-2 rounded-lg border-2 font-bold text-xl transition-all duration-150 relative overflow-hidden ";
                classes += isActive 
                    ? "bg-yellow-400 border-black text-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] translate-x-[-1px] translate-y-[-1px]"
                    : "bg-white border-gray-300 text-gray-500 hover:border-black hover:text-black hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] hover:translate-x-[-1px] hover:translate-y-[-1px]";
                
                btn.className = classes;
                btn.textContent = grade;
                btn.onclick = () => {
                    selectedGrade = grade;
                    searchTerm = ""; // 切換年級時清空搜尋
                    document.getElementById('search-input').value = "";
                    handleSearch(); // 更新顯示
                    renderGrades(); // 重新渲染按鈕狀態
                };
                container.appendChild(btn);
            });
        }

        // 處理搜尋與篩選邏輯
        function handleSearch() {
            const clearBtn = document.getElementById('clear-search');
            const hint = document.getElementById('search-result-hint');
            const termDisplay = document.getElementById('search-term-display');

            if (searchTerm.trim() !== "") {
                clearBtn.classList.remove('hidden');
                hint.classList.remove('hidden');
                termDisplay.textContent = searchTerm;
                // 當有搜尋時，重繪年級按鈕以移除選中狀態
                renderGrades();
            } else {
                clearBtn.classList.add('hidden');
                hint.classList.add('hidden');
                renderGrades();
            }
            renderResources();
        }

        // 渲染資源卡片
        function renderResources() {
            const container = document.getElementById('resources-grid');
            const noData = document.getElementById('no-data-hint');
            container.innerHTML = '';

            // 篩選
            const filtered = resources.filter(r => {
                if (searchTerm.trim() !== "") {
                    const lowerTerm = searchTerm.toLowerCase();
                    return r.title.toLowerCase().includes(lowerTerm) || 
                           r.subTitle.toLowerCase().includes(lowerTerm);
                }
                return r.grade === selectedGrade;
            });

            if (filtered.length === 0) {
                noData.classList.remove('hidden');
                document.getElementById('no-data-text').textContent = searchTerm 
                    ? `找不到與「${searchTerm}」相關的資源` 
                    : `目前 ${selectedGrade} 沒有相關資源`;
            } else {
                noData.classList.add('hidden');
                filtered.forEach(res => {
                    const card = createCard(res);
                    container.appendChild(card);
                });
                // 重新初始化新加入的 icons
                lucide.createIcons();
            }
        }

        // 建立單張卡片 HTML
        function createCard(res) {
            const div = document.createElement('div');
            div.className = "group bg-white rounded-2xl border-2 border-black cursor-pointer overflow-hidden relative hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] transition-all duration-200 hover:-translate-y-1 hover:-translate-x-1";
            div.onclick = () => openModal(res);

            // 處理圖片顯示與 Fallback
            // 如果有圖片網址，顯示圖片；否則顯示預設 icon
            let imageHtml = '';
            if (res.image) {
                // 使用 onerror 處理圖片載入失敗的情況
                imageHtml = `<img src="${res.image}" alt="${res.title}" class="w-full h-full object-contain relative z-10" onerror="this.onerror=null; this.parentNode.innerHTML='<div class=\\'flex flex-col items-center justify-center text-gray-400\\'><i data-lucide=\\'image\\' class=\\'w-12 h-12 mb-2 opacity-50\\'></i><span class=\\'text-xs font-bold\\'>尚無預覽圖</span></div>'; lucide.createIcons();">`;
            } else {
                imageHtml = `
                    <div class="flex flex-col items-center justify-center text-gray-400 relative z-10">
                        <i data-lucide="image" class="w-12 h-12 mb-2 opacity-50"></i>
                        <span class="text-xs font-bold">尚無預覽圖</span>
                    </div>
                `;
            }

            // 標籤 (搜尋模式時顯示年級)
            const gradeBadge = searchTerm ? `<span class="inline-block mb-2 text-xs font-black bg-black text-white px-2 py-0.5 rounded">${res.grade}</span>` : '';

            div.innerHTML = `
                <div class="h-56 bg-white relative flex items-center justify-center p-6 border-b-2 border-black group-hover:bg-yellow-50 transition-colors overflow-hidden">
                    ${imageHtml}
                    <div class="absolute bottom-3 right-3 bg-yellow-400 border-2 border-black p-1.5 rounded-lg z-10">
                        <i data-lucide="qr-code" class="w-6 h-6 text-black"></i>
                    </div>
                </div>
                <div class="p-5 text-center bg-white relative z-10">
                    ${gradeBadge}
                    <h3 class="text-xl font-black text-black mb-2">${res.title}</h3>
                    <div class="inline-block px-3 py-1 border-2 border-black rounded-full text-sm font-bold bg-gray-100">
                        ${res.subTitle}
                    </div>
                </div>
            `;
            return div;
        }

        // ================= Modal 相關 =================
        function openModal(res) {
            currentModalResource = res;
            const modal = document.getElementById('modal-overlay');
            const imgContainer = document.getElementById('modal-image-container');
            const title = document.getElementById('modal-title');
            const subTitle = document.getElementById('modal-subtitle');
            const linkBtn = document.getElementById('modal-link-btn');
            const qrImg = document.getElementById('modal-qr-img');
            const urlText = document.getElementById('modal-url-text');
            const fullQrImg = document.getElementById('full-qr-img');
            const fullQrTitle = document.getElementById('full-qr-title');

            // 填入內容
            title.textContent = res.title;
            subTitle.textContent = res.subTitle;
            linkBtn.href = res.url;
            urlText.textContent = res.url;

            // 處理 Modal 圖片
            if (res.image) {
                imgContainer.innerHTML = `<img src="${res.image}" class="max-w-full max-h-full object-contain drop-shadow-md border-2 border-black rounded-lg bg-white" onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                                          <div class="hidden flex flex-col items-center justify-center text-gray-400"><i data-lucide="image" class="w-16 h-16 mb-2"></i><span>圖片載入失敗</span></div>`;
            } else {
                imgContainer.innerHTML = `<div class="flex flex-col items-center justify-center text-gray-400"><i data-lucide="image" class="w-16 h-16 mb-2 opacity-50"></i><span class="font-bold">尚無預覽圖</span></div>`;
            }

            // QR Code
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(res.url)}`;
            qrImg.src = qrUrl;
            fullQrImg.src = qrUrl;
            fullQrTitle.textContent = res.title;

            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            currentModalResource = null;
        }

        function toggleFullQr() {
            const overlay = document.getElementById('full-qr-overlay');
            if (overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function copyUrl() {
            if (!currentModalResource) return;
            navigator.clipboard.writeText(currentModalResource.url).then(() => {
                const tooltip = document.getElementById('copy-tooltip');
                tooltip.classList.remove('hidden');
                setTimeout(() => tooltip.classList.add('hidden'), 2000);
            });
        }

        // ================= Scroll To Top =================
        function handleScroll() {
            const btn = document.getElementById('scroll-to-top');
            if (window.scrollY > 300) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

    </script>
</body>
</html>